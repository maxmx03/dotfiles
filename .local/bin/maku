#!/usr/bin/env bash

MAKU_CONFIG_FILE="maku.build"

if [[ "$1" = "init" ]]; then
  echo '# vim: ft=sh
BUILD="./build"
SOURCE="./src"
INCLUDE="./include"
CC="gcc"
CFLAGS="-std=c99"' >"$MAKU_CONFIG_FILE"
  exit 0
fi

if [[ ! -f "$MAKU_CONFIG_FILE" ]]; then
  echo "please run 'maku init' first"
  exit 1
fi

source ./"$MAKU_CONFIG_FILE"

if [ ! -d "$BUILD" ]; then
  mkdir $BUILD
fi

ls $SOURCE | xargs -I {} basename {} .c | xargs -I {} $CC -MD -MF $BUILD/{}.d $CFLAGS -I$INCLUDE -c ./src/{}.c -o $BUILD/{}.o
cd $BUILD && ls *.o | xargs "$CC" -o program
